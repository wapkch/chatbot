# ChatMe å›¾ç‰‡åŠŸèƒ½è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

ä¸º ChatMe æ·»åŠ å›¾ç‰‡å‘é€åŠŸèƒ½ï¼Œå‚è€ƒ ChatGPT iOS çš„äº¤äº’è®¾è®¡ã€‚

### åŠŸèƒ½èŒƒå›´

- ä»ç›¸å†Œé€‰æ‹©å›¾ç‰‡å‘é€
- æ‹ç…§å‘é€
- æ”¯æŒå¤šé€‰ï¼ˆæœ€å¤š 4 å¼ ï¼‰
- å›¾ç‰‡å‹ç¼©åé€šè¿‡ Base64 åµŒå…¥ OpenAI Vision API

## UI äº¤äº’è®¾è®¡

### 1. è¾“å…¥åŒºåŸŸæ”¹é€ 

**å½“å‰çŠ¶æ€**ï¼š
```
[    è¾“å…¥æ¡†    ] [å‘é€]
```

**æ”¹é€ å**ï¼š
```
[+] [    è¾“å…¥æ¡†    ] [å‘é€]
```

å½“æœ‰å›¾ç‰‡é€‰ä¸­æ—¶ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [å›¾1 Ã—] [å›¾2 Ã—] [å›¾3 Ã—]     â”‚  â† å›¾ç‰‡é¢„è§ˆè¡Œï¼ˆæ¨ªå‘æ»šåŠ¨ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [+] [  è¾“å…¥æ¡†  ]     [å‘é€] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. åº•éƒ¨é¢æ¿

ç‚¹å‡» "+" æŒ‰é’®åå¼¹å‡ºåº•éƒ¨é¢æ¿ï¼ˆSheetï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”€â”€â”€â”€â”€  (æ‹–æ‹½æ¡)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ChatMe              All Photos  â”‚  â† æ ‡é¢˜ + è·³è½¬ç›¸å†ŒæŒ‰é’®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚  ğŸ“·  â”‚ â”‚ ç…§ç‰‡1â”‚ â”‚ ç…§ç‰‡2â”‚ ... â”‚  â† æ¨ªå‘æ»šåŠ¨
â”‚ â”‚ ç›¸æœº â”‚ â”‚  âœ“1  â”‚ â”‚      â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚      Add 2 photos           â”‚ â”‚  â† ç¡®è®¤æŒ‰é’®ï¼ˆé€‰ä¸­æ—¶å‡ºç°ï¼‰
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. äº¤äº’ç»†èŠ‚

| æ“ä½œ | è¡Œä¸º |
|------|------|
| ç‚¹å‡»ç›¸æœº | æ‰“å¼€ç³»ç»Ÿç›¸æœºæ‹ç…§ |
| ç‚¹å‡»ç…§ç‰‡ | é€‰ä¸­/å–æ¶ˆé€‰ä¸­ï¼Œæ˜¾ç¤ºè“è‰²è¾¹æ¡†+åºå·è§’æ ‡ |
| ç‚¹å‡» "All Photos" | æ‰“å¼€ç³»ç»Ÿç›¸å†Œå…¨å±é€‰æ‹©å™¨ |
| ç‚¹å‡» "Add N photos" | å…³é—­é¢æ¿ï¼Œå›¾ç‰‡æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†ä¸Šæ–¹ |
| ç‚¹å‡»é¢„è§ˆå›¾çš„ Ã— | ç§»é™¤è¯¥å›¾ç‰‡ |
| ç‚¹å‡»å‘é€ | å‘é€æ–‡æœ¬+å›¾ç‰‡ï¼Œæ¸…ç©ºé¢„è§ˆ |

## æ•°æ®æ¨¡å‹

### 1. Core Data æ‰©å±•

**Message å®ä½“æ–°å¢å­—æ®µ**ï¼š
```swift
@NSManaged public var imageAttachments: String?  // JSON æ•°ç»„ï¼Œå­˜å‚¨å›¾ç‰‡æ–‡ä»¶ååˆ—è¡¨
// ä¾‹å¦‚: ["uuid1.jpg", "uuid2.jpg"]
```

### 2. å›¾ç‰‡å­˜å‚¨ç»“æ„

```
App Documents/
â””â”€â”€ Images/
    â”œâ”€â”€ originals/           # å‹ç¼©åçš„"åŸå›¾"ï¼ˆå‘é€ç”¨ï¼‰
    â”‚   â”œâ”€â”€ uuid1.jpg
    â”‚   â””â”€â”€ uuid2.jpg
    â””â”€â”€ thumbnails/          # ç¼©ç•¥å›¾ï¼ˆåˆ—è¡¨æ˜¾ç¤ºç”¨ï¼Œ200x200ï¼‰
        â”œâ”€â”€ uuid1_thumb.jpg
        â””â”€â”€ uuid2_thumb.jpg
```

### 3. ImageAttachment æ¨¡å‹

```swift
struct ImageAttachment: Identifiable, Codable {
    let id: UUID
    let fileName: String           // "uuid.jpg"
    let createdAt: Date

    var originalURL: URL { ... }   // è®¡ç®—å±æ€§ï¼ŒæŒ‡å‘ originals/
    var thumbnailURL: URL { ... }  // è®¡ç®—å±æ€§ï¼ŒæŒ‡å‘ thumbnails/
}
```

### 4. å›¾ç‰‡å¤„ç†æµç¨‹

```
ç”¨æˆ·é€‰æ‹©å›¾ç‰‡
    â†“
å‹ç¼©å›¾ç‰‡ï¼ˆæœ€å¤§ 2048pxï¼Œè´¨é‡ 80%ï¼‰
    â†“
ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆ200x200ï¼‰
    â†“
ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿï¼ˆoriginals/ + thumbnails/ï¼‰
    â†“
è¿”å› ImageAttachment å¯¹è±¡
    â†“
æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†ä¸Šæ–¹é¢„è§ˆ
    â†“
å‘é€æ—¶ï¼šè¯»å– original â†’ è½¬ Base64 â†’ æ„å»º Vision API è¯·æ±‚
    â†“
å‘é€æˆåŠŸï¼šä¿å­˜ imageAttachments JSON åˆ° Message
```

## API é›†æˆ

### 1. OpenAI Vision API æ ¼å¼

```json
{
  "model": "gpt-4o",
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "è¿™å¼ å›¾ç‰‡é‡Œæœ‰ä»€ä¹ˆï¼Ÿ"
        },
        {
          "type": "image_url",
          "image_url": {
            "url": "data:image/jpeg;base64,/9j/4AAQSkZ..."
          }
        }
      ]
    }
  ]
}
```

### 2. ChatMessage æ¨¡å‹æ”¹é€ 

```swift
// æ”¹é€ ä¸ºæ”¯æŒå¤šæ¨¡æ€
struct ChatMessage: Codable {
    let role: Role
    let content: MessageContent
}

enum MessageContent: Codable {
    case text(String)                           // çº¯æ–‡æœ¬æ¶ˆæ¯
    case multimodal([ContentPart])              // å¤šæ¨¡æ€æ¶ˆæ¯
}

enum ContentPart: Codable {
    case text(String)
    case imageURL(String)  // Base64 data URL
}
```

### 3. å…¼å®¹æ€§å¤„ç†

- çº¯æ–‡æœ¬æ¶ˆæ¯ï¼šç»§ç»­ä½¿ç”¨ç®€å•çš„ `content: String` æ ¼å¼
- å¸¦å›¾ç‰‡æ¶ˆæ¯ï¼šä½¿ç”¨ `content: [ContentPart]` æ•°ç»„æ ¼å¼
- ä¿æŒå¯¹ä¸æ”¯æŒ Vision çš„æ¨¡å‹çš„å…¼å®¹æ€§

## æ¶ˆæ¯æ°”æ³¡æ˜¾ç¤º

### 1. ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡ï¼ˆå¸¦å›¾ç‰‡ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ å›¾1  â”‚ â”‚ å›¾2  â”‚          â”‚  â† ç¼©ç•¥å›¾ç½‘æ ¼ï¼ˆæœ€å¤š2x2ï¼‰
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚  è¿™å¼ å›¾ç‰‡é‡Œæœ‰ä»€ä¹ˆï¼Ÿ          â”‚  â† æ–‡æœ¬å†…å®¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         15:30  â† æ—¶é—´æˆ³
```

### 2. å›¾ç‰‡å¸ƒå±€è§„åˆ™

| å›¾ç‰‡æ•°é‡ | å¸ƒå±€ |
|---------|------|
| 1 å¼  | å•å›¾æ˜¾ç¤ºï¼Œå®½åº¦æœ€å¤§ 200pt |
| 2 å¼  | æ¨ªå‘å¹¶æ’ |
| 3 å¼  | ä¸Š 1 ä¸‹ 2 |
| 4 å¼  | 2x2 ç½‘æ ¼ |

### 3. å…¨å±å›¾ç‰‡æŸ¥çœ‹å™¨

- å…¨å±æ˜¾ç¤ºå›¾ç‰‡ï¼ˆä» originals/ åŠ è½½ï¼‰
- æ”¯æŒåŒæŒ‡ç¼©æ”¾ã€æ‹–åŠ¨
- é¡¶éƒ¨å…³é—­æŒ‰é’®
- å¤šå¼ å›¾ç‰‡æ”¯æŒå·¦å³æ»‘åŠ¨åˆ‡æ¢

## æ–‡ä»¶ç»“æ„

```
æ–°å¢æ–‡ä»¶:
â”œâ”€â”€ Views/
â”‚   â”œâ”€â”€ ImagePickerSheet.swift      # åº•éƒ¨é¢æ¿ï¼ˆç›¸æœº+ç›¸å†Œï¼‰
â”‚   â”œâ”€â”€ ImagePreviewRow.swift       # è¾“å…¥æ¡†ä¸Šæ–¹çš„å›¾ç‰‡é¢„è§ˆè¡Œ
â”‚   â”œâ”€â”€ ImageThumbnailView.swift    # å•ä¸ªç¼©ç•¥å›¾ç»„ä»¶ï¼ˆå«åˆ é™¤/é€‰ä¸­çŠ¶æ€ï¼‰
â”‚   â””â”€â”€ FullScreenImageViewer.swift # å…¨å±æŸ¥çœ‹å›¾ç‰‡
â”‚
â”œâ”€â”€ Services/
â”‚   â””â”€â”€ ImageStorageService.swift   # å›¾ç‰‡å­˜å‚¨/è¯»å–/å‹ç¼©
â”‚
â”œâ”€â”€ Models/
â”‚   â””â”€â”€ ImageAttachment.swift       # å›¾ç‰‡é™„ä»¶æ¨¡å‹
â”‚
ä¿®æ”¹æ–‡ä»¶:
â”œâ”€â”€ Views/ChatView.swift            # æ·»åŠ  + æŒ‰é’®å’Œå›¾ç‰‡é¢„è§ˆ
â”œâ”€â”€ Views/MessageBubbleView.swift   # æ”¯æŒæ˜¾ç¤ºå›¾ç‰‡
â”œâ”€â”€ ViewModels/ChatViewModel.swift  # æ·»åŠ å›¾ç‰‡çŠ¶æ€ç®¡ç†
â”œâ”€â”€ Services/OpenAIService.swift    # æ”¯æŒ Vision API æ ¼å¼
â””â”€â”€ Models/Message.swift            # æ·»åŠ  imageAttachments å­—æ®µ
```

## å®ç°ç»†èŠ‚

### 1. æƒé™å¤„ç†

```swift
// ç›¸æœºæƒé™
AVCaptureDevice.requestAccess(for: .video)

// ç›¸å†Œæƒé™ï¼ˆiOS 14+ ä½¿ç”¨ PHPickerï¼Œæ— éœ€å®Œæ•´æƒé™ï¼‰
// PHPickerViewController è‡ªåŠ¨å¤„ç†æœ‰é™è®¿é—®
```

### 2. å›¾ç‰‡å‹ç¼©å‚æ•°

```swift
struct ImageCompressionConfig {
    static let maxDimension: CGFloat = 2048    // æœ€å¤§è¾¹é•¿
    static let compressionQuality: CGFloat = 0.8  // JPEG è´¨é‡
    static let thumbnailSize: CGFloat = 200    // ç¼©ç•¥å›¾å°ºå¯¸
    static let maxImageCount: Int = 4          // æœ€å¤šé€‰æ‹©æ•°é‡
}
```

### 3. é”™è¯¯å¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|----------|
| ç›¸æœºä¸å¯ç”¨ï¼ˆæ¨¡æ‹Ÿå™¨ï¼‰ | éšè—ç›¸æœºæŒ‰é’®æˆ–æ˜¾ç¤ºæç¤º |
| å›¾ç‰‡åŠ è½½å¤±è´¥ | æ˜¾ç¤ºå ä½å›¾ + é‡è¯•æŒ‰é’® |
| å­˜å‚¨ç©ºé—´ä¸è¶³ | Toast æç¤ºç”¨æˆ· |
| API ä¸æ”¯æŒå›¾ç‰‡ | æç¤º"å½“å‰æ¨¡å‹ä¸æ”¯æŒå›¾ç‰‡" |

### 4. æ€§èƒ½ä¼˜åŒ–

- ç¼©ç•¥å›¾æ‡’åŠ è½½ï¼šä½¿ç”¨ `AsyncImage` æˆ–è‡ªå®šä¹‰ç¼“å­˜
- åå°å‹ç¼©ï¼šå›¾ç‰‡å¤„ç†åœ¨åå°çº¿ç¨‹æ‰§è¡Œ
- å†…å­˜ç®¡ç†ï¼šå¤§å›¾ç‰‡åŠæ—¶é‡Šæ”¾ï¼Œåªä¿ç•™ç¼©ç•¥å›¾å¼•ç”¨

### 5. æ¸…ç†ç­–ç•¥

```swift
// åˆ é™¤æ¶ˆæ¯æ—¶ï¼ŒåŒæ­¥åˆ é™¤å…³è”å›¾ç‰‡æ–‡ä»¶
func deleteMessage(_ message: Message) {
    // 1. è§£æ imageAttachments JSON
    // 2. åˆ é™¤ originals/ å’Œ thumbnails/ ä¸­çš„æ–‡ä»¶
    // 3. åˆ é™¤ Core Data è®°å½•
}
```
